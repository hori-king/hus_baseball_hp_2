name: Deploy to Sakura VPS

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew
      
    - name: Build with Gradle
      run: ./gradlew build -x test


    - name: SCP Executable JAR to Server

      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}

        # ↓↓↓ sourceから-plain.jarを除外する ↓↓↓
        source: "build/libs/!(*-plain).jar"

        target: "~/temp-deploy"
        strip_components: 2

    - name: Deploy and Restart Application
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |

          pkill -f 'hus_baseball_hp' || true
          sleep 5
          
          mkdir -p /opt/jyunko-app
          
          rm -f /opt/jyunko-app/*.jar
          rm -f /opt/jyunko-app/app.log
          
          # 転送されたJARファイルを移動

          mv ~/temp-deploy/*.jar /opt/jyunko-app/
          
          # .envファイルを作成
          echo "${{ secrets.ENV_FILE }}" > /opt/jyunko-app/.env
          
          # アプリケーションをバックグラウンドで起動
          cd /opt/jyunko-app
          nohup java -jar *.jar > app.log 2>&1 &
          
          # 一時ディレクトリをクリーンアップ
          rm -rf ~/temp-deploy
